<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Inconsolata"
    />
    <style>
      body,
      html {
        height: 100%;
        font-family: "Inconsolata", sans-serif;
      }

      .bgimg {
        background-position: center;
        background-size: cover;
        background-image: url("/w3images/coffeehouse.jpg");
        min-height: 75%;
      }

      .menu {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="w3-container" id="where" style="padding-bottom: 32px">
      <div class="w3-content" style="max-width: 700px">
        <MENU_HERE>
        </iframe>
        <h1 id="titulo">Search for a film info</h1>
        <h3 id="subtitulo"></h3>
        <h4 id="errorText" style="color: red"></h4>
        <form
          class="w3-input w3-padding-16 w3-border"
          action="/search"
          method="post"
        >
          <p>
            Title:
            <input
              class="w3-input w3-padding-16 w3-border"
              id="title"
              name="title"
              value=""
            />
            <br />
          </p>
          <p>
            Year:
            <input
              type="number"
              class="w3-input w3-padding-16 w3-border"
              id="year"
              name="year"
              value=""
            />
            <br />
          </p>
          <p>
            <input
              class="w3-button w3-black"
              type="button"
              value="Enviar"
              onclick="doIt()"
            />
          </p>
        </form>
      </div>
    </div>
    <div class="w3-container" id="where" style="padding-bottom: 32px">
      <div class="w3-content" id="parsersList" style="max-width: 700px">
        <h3 id="results">Results</h3>
        <p id="cachedText" style="color: blue"></p>
        <!-- Parser list here (dinamycally loaded) -->
      </div>
    </div>

    <script>
      /** Nomina de parsers */
      let parsers = null;

      // Agrega un nuevo parser a la lista de parser disponible
      function appendParsersToDOM(name) {
        // Incorporar esto:
        // <p>
        //   <span class="w3-tag">IMDb:</span>
        //   <span id="imdbParser">Waiting for a film...</span>
        // </p>

        // P
        let p = document.createElement("p");
        // Span1
        let span1 = document.createElement("span");
        span1.className = "w3-tag";
        let text1 = document.createTextNode(`${name}:`);
        span1.appendChild(text1);
        // Span2
        let span2 = document.createElement("span");
        span2.id = `${name}parser`;
        let text2 = document.createTextNode(" Waiting for a film...");
        span2.appendChild(text2);
        // Incorporarlo al DOM
        p.appendChild(span1);
        p.appendChild(span2);
        let element = document.getElementById("parsersList");
        element.appendChild(p);
      }

      // Mostrar en pantalla los parsers disponibles
      async function getParsers() {
        const response = await fetch("/parsers");
        parsers = await response.json();
        const subtitulo = document.getElementById("subtitulo");
        subtitulo.textContent = `Current sources: ${parsers.names}`;
      }

      // Retorna el parametro especificado dentro de la URL
      function getURLParameter(sParam) {
        let sPageURL = window.location.search.substring(1);
        let sURLVariables = sPageURL.split('&');
        for (var i = 0; i < sURLVariables.length; i++) {
          let sParameterName = sURLVariables[i].split('=');
          if (sParameterName[0] == sParam) {
            return sParameterName[1];
          }
        }
      }

      // Carga los campos de busqueda si corresponde
      function loadSearchFields() {
        let title = getURLParameter("title");
        let year = getURLParameter("year");
        document.getElementById("title").value = decodeURIComponent(title);
        document.getElementById("year").value = year;
      }

      // Carga la info inicial
      async function loadInfo() {
        loadSearchFields();
        await getParsers();
        parsers.names.forEach((element) => {
          appendParsersToDOM(element);
        });
        // Fetch automatico?
        let auto = getURLParameter("auto");
        if (auto) {
          doIt();
        }
      }

      // Cargar la info
      loadInfo();

      function setError(error) {
        document.getElementById("errorText").textContent = error;
      }

      function setCached(cached) {
        document.getElementById("cachedText").textContent = cached;
      }

      // ===== Funciones relacioandas con la consulta =====
      let requestID = -1;
      let checks = 0;

      // Barrer con todos los parsers
      async function doIt() {
        setError("");
        setCached("");
        // Registrar el pedido
        const title = document.getElementById("title").value;
        const year = document.getElementById("year").value;
        query(title, year);
      }

      // Consultar por una pelicula con todos los parsers
      async function query(title, year) {
        try {
          // Enviar criterio al server
          const response = await fetch(
            `/search/all?title=${encodeURIComponent(title)}&year=${year}`
          );
          // Recuperar id de request de busqueda
          const json = await response.json();
          if (json && json.id > -1) {
            requestID = json.id;
            if (json.cached) {
              setCached(`Retrieved ${json.cached}`);
              setTimeout(checkStatus, 1);
            } else {
              parsers.names.forEach((parserName) => {
                document.getElementById(`${parserName}parser`).textContent =
                  " Retrieving info...";
              });
              setTimeout(checkStatus, 1000);
            }
          } else {
            requestID = -1;
            setError("No response from server");
          }
        } catch (ex) {
          setError("Error conecting to server");
        }
      }

      function getDataInfo(json) {
        let result = "";
        if (json.publicScore) {
          result += ` ${json.publicScore} (${json.publicCount} votes) `;
        }
        if (json.criticsScore) {
          result += ` ${json.criticsScore} (${json.criticsCount} critics) `;
        }
        if (json.budget) {
          result += ` ${json.budget} budget, ${json.boxOffice} box office `;
        }
        if (json.error) {
          result += ` ${json.error} for ${title} (${year})`;
        }
        return result;
      }

      // Checkear el estado de la busqueda usando el ID de request recibido
      async function checkStatus() {
        try {
          checks++;
          const statusURL = `/search/status/${requestID}`;
          const response = await fetch(statusURL);
          const parsed = await response.text();
          let recall = true;
          // Recibimos alguna info?
          if (parsed && parsed.length > 0) {
            const data = JSON.parse(parsed);
            data.forEach((element) => {
              document.getElementById(
                `${element.parser}parser`
              ).textContent = getDataInfo(element);
            });
            // Se recuperÃ³ toda la informacion buscada o debemos repetir polling?
            if (data.length == parsers.names.length) {
              recall = false;
              checks = 0;
            }
          }
          if (checks >= 10) {
            checks = 0;
            recall = false;
            setError("Too many retries");
          }
          // Reconsultar en un ratitin
          if (recall) setTimeout(checkStatus, 1000);
        } catch (ex) {
          setError("Error " + ex);
        }
      }

      // Consultar por una pelicula bajo un parser en particular
      async function queryForParser(title, year, parserTag, parserName) {
        document.getElementById(parserTag).textContent = " Retrieving info...";
        // Enviar criterio al server
        const response = await fetch(
          `/search/${parserName}?title=${encodeURIComponent(
            title
          )}&year=${year}`
        );
        // Recuperar data en informar la eventual informacion contenida
        const json = await response.json();
        let result = getDataInfo(json);
        document.getElementById(parserTag).textContent = result;
      }
    </script>
  </body>
</html>
