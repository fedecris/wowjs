<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Inconsolata"
    />
    <style>
      body,
      html {
        height: 100%;
        font-family: "Inconsolata", sans-serif;
      }

      .bgimg {
        background-position: center;
        background-size: cover;
        background-image: url("/w3images/coffeehouse.jpg");
        min-height: 75%;
      }

      .menu {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="w3-container" id="where" style="padding-bottom: 32px;">
      <div class="w3-content" style="max-width: 700px;">
        <h1 id="titulo">Search for a film info</h1>
        <h3 id="subtitulo"></h3>
        <form
          class="w3-input w3-padding-16 w3-border"
          action="/search"
          method="post"
        >
          <p>
            Title:
            <input
              class="w3-input w3-padding-16 w3-border"
              id="title"
              name="title"
              value="The Matrix"
            />
            <br />
          </p>
          <p>
            Year:
            <input
              class="w3-input w3-padding-16 w3-border"
              id="year"
              name="year"
              value="1999"
            />
            <br />
          </p>
          <p>
            <input
              class="w3-button w3-black"
              type="button"
              value="Enviar"
              onclick="doIt()"
            />
          </p>
        </form>
      </div>
    </div>
    <div class="w3-container" id="where" style="padding-bottom: 32px;">
      <div class="w3-content" id="parsersList" style="max-width: 700px;">
        <h3 id="results">Results</h3>
        <!-- Parser list here (dinamycally loaded) -->
      </div>
    </div>

    <script>
      /** Nomina de parsers */
      let parsers = null;

      // Agrega un nuevo parser a la lista de parser disponible
      function appendParsersToDOM(tagID, name) {
        // Incorporar esto:
        // <p>
        //   <span class="w3-tag">IMDb:</span>
        //   <span id="imdbParser">Waiting for a film...</span>
        // </p>

        // P
        let p = document.createElement("p");
        // Span1
        let span1 = document.createElement("span");
        span1.className = "w3-tag";
        let text1 = document.createTextNode(`${name}:`);
        span1.appendChild(text1);
        // Span2
        let span2 = document.createElement("span");
        span2.id = tagID;
        let text2 = document.createTextNode(" Waiting for a film...");
        span2.appendChild(text2);
        // Incorporarlo al DOM
        p.appendChild(span1);
        p.appendChild(span2);
        let element = document.getElementById("parsersList");
        element.appendChild(p);
      }

      // Mostrar en pantalla los parsers disponibles
      async function getParsers() {
        const response = await fetch("/parsers");
        parsers = await response.json();
        const subtitulo = document.getElementById("subtitulo");
        subtitulo.textContent = `Current sources: ${parsers.names}`;
      }

      // Carga la info inicial
      async function loadInfo() {
        await getParsers();
        let i = 0;
        parsers.names.forEach((element) => {
          let tagID = `parser${i++}`;
          appendParsersToDOM(tagID, element);
        });
      }

      // Cargar la info
      loadInfo();

      // ===== Funciones relacioandas con la consulta =====

      // Barrer con todos los parsers
      function doIt() {
        let i = 0;
        parsers.names.forEach((element) => {
          let tagID = `parser${i++}`;
          query(tagID, element);
        });
      }

      // Consultar por una pelicula bajo un parser en particular
      async function query(parserTag, parserName) {
        document.getElementById(parserTag).textContent = " Retrieving info...";
        // Enviar criterio al server
        const title = document.getElementById("title").value;
        const year = document.getElementById("year").value;
        const response = await fetch(
          `/search/${parserName}?title=${encodeURIComponent(
            title
          )}&year=${year}`
        );
        // Recuperar data en informar la eventual informacion contenida
        const json = await response.json();
        let result = "";
        if (json.publicScore) {
          result += ` ${json.publicScore} (${json.publicCount} votes) `;
        }
        if (json.budget) {
          result += ` ${json.budget} budget, ${json.boxOffice} box office `;
        }
        document.getElementById(parserTag).textContent = result;
      }
    </script>
  </body>
</html>
